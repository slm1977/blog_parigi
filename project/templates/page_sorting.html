{% extends "bootstrap/base.html" %}

{% block content %}

<style>
  body {margin-left:20px;}
  body.dragging, body.dragging * {
  cursor: move !important;
}

.dragged {
  position: absolute;
  opacity: 0.5;
  z-index: 2000;
}

ol.serialization li.placeholder {
  position: relative;
  /** More li styles **/
}
ol.serialization li.placeholder:before {
  position: absolute;
  /** Define arrowhead **/
}
</style>

<h1>Ordine delle pagine nel menu</h1>

<form style="margin-left:10px;" id="sorting_form" method="POST", action="{{url_for("pages.save_page")}}">
<p>


<!-- Button trigger modal -->
    <button type="button" id="exitButton" class="btn btn-primary">
      Esci
    </button>

    <input type="submit" id="saveButton" class="btn btn-primary" value="Applica"/>

<div style="margin-top:10px;" class="alert" role="alert" id="formResponse">
</div>
</p>



    <div id="editor" name="editor_div">
        <p id="page_content">{{content|safe}}</p>
    </div>

</form>
<ol class='serialization'>
  {% for p in pages %}
  <li id="{{p.id}}" class="serialize alert alert-success">{{p.menu_title}}</li>
   {% endfor %}
{% endblock %}


{% block scripts %}
<!--<script src="{{url_for('.static', filename='myscripts.js')}}"></script> -->
{{super()}}

<script src="{{url_for('.static', filename='js/jquery_sortable.js')}}"></script>

    <script type="text/javascript">
        // Shorthand for $( document ).ready()
        $(function() {

        var pages_id = [];

        var group = $("ol.serialization").sortable({
                group: 'limited_drop_targets',
                isValidTarget: function  ($item, container) {
                  if($item.is(".highlight"))
                    return true;
                  else
                    return $item.parent("ol")[0] == container.el[0];
                },
                onDrop: function ($item, container, _super) {

                   // aggiorno il valore degli id delle pagine
                   pages_id =  group.sortable("serialize").get().join("\n");
                   console.log(pages_id);

                  _super($item, container);
                },
                serialize: function (parent, children, isContainer) {
                  return isContainer ? children.join() : parent.attr("id");
                },
                tolerance: 6,
                distance: 10
              });

             var frm = $('#sorting_form');


            frm.submit(function (e) {

                e.preventDefault();

                $.ajax({
                    type: frm.attr('method'),
                    url: frm.attr('action'),
                    data: { 'pages_id': CKEDITOR.instances.editor.getData(),

                    },
                    success: function (data) {
                        console.log('Submission was successful.');
                        console.log(data);
                        if (data["success"]  == true)
                            {
                                modified = false;
                                $('#formResponse').removeClass("alert-danger");
                                $('#formResponse').addClass("alert-success");
                                $('#formResponse').html(data["message"]);

                                if (exitRequest==true)
                                window.location.href="{{url_for('main.presentazione')}}";
                            }
                           else

                                 {
                                 // in caso di problemi annullo la richiesta di uscita
                                 exitRequest = false;
                                $('#formResponse').removeClass("alert-success");
                                $('#formResponse').addClass("alert-danger");
                                $('#formResponse').html(data["message"]);
                                }

                    },
                    error: function (data) {
                        console.log('An error occurred.');
                        console.log(data);
                        // in caso di problemi annullo la richiesta di uscita
                        exitRequest==false;
                        $('#formResponse').removeClass("alert-success");
                        $('#formResponse').addClass("alert-danger");
                        $('#formResponse').html("Si sono verificati problemi nel salvataggio: %s" % data);
                    },
                });// AJAX end


            });  // frm submit end

          }); // function END

</script>


{% endblock %}
